# パーセンタイル処理の解説

## 概要

`validate_dataset.py`では、データセットの統計的特性を理解するために、**パーセンタイル（Percentile）**を計算しています。パーセンタイルは、データの分布を理解するための重要な統計量です。

## パーセンタイルとは

**パーセンタイル**は、データの分布を表す統計量で、**特定のパーセンテージの値がその値以下になるような値**を示します。

例えば：
- **50パーセンタイル（中央値）**: データの50%がその値以下になるような値
- **25パーセンタイル（第1四分位数）**: データの25%がその値以下になるような値
- **75パーセンタイル（第3四分位数）**: データの75%がその値以下になるような値

## コードでの実装

### 1. `validate_channel`関数でのパーセンタイル計算

```python
# Percentiles
percentiles = [1, 5, 10, 25, 50, 75, 90, 95, 99]
print(f"\nPercentiles:")
for p in percentiles:
    val = np.percentile(valid_arr, p)
    print(f"  {p:2d}%: {val:12.6f}")
```

**計算対象**: `valid_arr`（NaN/Infを除外した有効な値のみ）

**計算するパーセンタイル**:
- **1%**: データの1%がその値以下
- **5%**: データの5%がその値以下
- **10%**: データの10%がその値以下
- **25%**: 第1四分位数（Q1）
- **50%**: 中央値（Median、Q2）
- **75%**: 第3四分位数（Q3）
- **90%**: データの90%がその値以下
- **95%**: データの95%がその値以下
- **99%**: データの99%がその値以下

### 2. `validate_array`関数でのパーセンタイル計算

```python
# Percentiles
percentiles = [1, 5, 25, 50, 75, 95, 99]
print(f"\nPercentiles:")
for p in percentiles:
    val = np.percentile(valid_arr, p)
    print(f"  {p:2d}%: {val:.6f}")
```

**計算対象**: `valid_arr`（NaN/Infを除外した有効な値のみ）

**計算するパーセンタイル**:
- **1%**: データの1%がその値以下
- **5%**: データの5%がその値以下
- **25%**: 第1四分位数（Q1）
- **50%**: 中央値（Median、Q2）
- **75%**: 第3四分位数（Q3）
- **95%**: データの95%がその値以下
- **99%**: データの99%がその値以下

## 処理の流れ

### 1. 有効な値の抽出

```python
# Statistics (only for valid values)
valid_mask = np.isfinite(ch_data)  # NaN/Infを除外
valid_count = valid_mask.sum()

if valid_count > 0:
    valid_arr = ch_data[valid_mask]  # 有効な値のみを抽出
```

**重要**: パーセンタイルは、**NaN/Infを除外した有効な値のみ**に対して計算されます。

### 2. パーセンタイルの計算

```python
val = np.percentile(valid_arr, p)
```

**`np.percentile`の動作**:
- `valid_arr`をソート
- 指定されたパーセンテージ（`p`）に対応する値を計算
- 線形補間を使用して中間値を計算（デフォルト）

### 3. 結果の表示

```python
print(f"  {p:2d}%: {val:12.6f}")
```

**表示形式**: `パーセンテージ%: 値`

## パーセンタイルの意味

### 分布の理解

パーセンタイルは、データの分布を理解するために使用されます：

1. **中央値（50%）**: データの中央値。外れ値の影響を受けにくい。
2. **四分位数（25%, 75%）**: データの分布の範囲を表す。
3. **極端な値（1%, 99%）**: データの両端の値を表す。外れ値の検出に役立つ。

### 外れ値の検出

パーセンタイルを使用して、外れ値を検出できます：

- **1%以下または99%以上**: 極端に小さい値または大きい値
- **5%以下または95%以上**: 外れ値の可能性がある値

### データのスケールの理解

パーセンタイルを使用して、データのスケールを理解できます：

- **範囲**: 99パーセンタイル - 1パーセンタイル = データの大部分の範囲
- **中央値**: データの中央値
- **四分位範囲（IQR）**: 75パーセンタイル - 25パーセンタイル = データの中央50%の範囲

## 実際の使用例

### 例1: チャンネルごとの統計

```python
# Channel 0のパーセンタイル
Percentiles:
  1%:   -2.123456
  5%:   -1.789012
 10%:   -1.456789
 25%:   -0.987654
 50%:   -0.345678  # 中央値
 75%:    0.234567
 90%:    0.567890
 95%:    0.789012
 99%:    1.123456
```

**解釈**:
- データの50%が`-0.345678`以下
- データの99%が`1.123456`以下
- データの範囲は約`-2.12`から`1.12`

### 例2: 外れ値の検出

```python
# Channel 1のパーセンタイル（極端な値がある場合）
Percentiles:
  1%:   -1000000.000000  # 極端に小さい値
  5%:   -999999.000000
 25%:   -29.020802
 50%:   -0.035337
 75%:    0.006624
 95%:    999999.000000
 99%:    1000000.000000  # 極端に大きい値
```

**解釈**:
- データの1%が`-1000000`以下（極端に小さい値）
- データの99%が`1000000`以下（極端に大きい値）
- これらの値は、データクリッピングやプレースホルダー値の可能性がある

## コードの違い

### `validate_channel`関数

- **より詳細なパーセンタイル**: `[1, 5, 10, 25, 50, 75, 90, 95, 99]`
- **チャンネルごとの詳細な統計**: 各チャンネルに対して詳細な統計を提供

### `validate_array`関数

- **基本的なパーセンタイル**: `[1, 5, 25, 50, 75, 95, 99]`
- **全体の統計**: データセット全体の統計を提供

## 重要なポイント

### 1. NaN/Infの除外

パーセンタイルは、**NaN/Infを除外した有効な値のみ**に対して計算されます：

```python
valid_mask = np.isfinite(ch_data)  # NaN/Infを除外
valid_arr = ch_data[valid_mask]    # 有効な値のみを抽出
val = np.percentile(valid_arr, p)  # 有効な値に対してパーセンタイルを計算
```

### 2. データの分布の理解

パーセンタイルを使用して、データの分布を理解できます：

- **対称分布**: 25%と75%が中央値からほぼ等距離
- **右に歪んだ分布**: 75%が中央値から遠い
- **左に歪んだ分布**: 25%が中央値から遠い

### 3. 外れ値の検出

パーセンタイルを使用して、外れ値を検出できます：

- **極端な値**: 1%以下または99%以上の値
- **外れ値の可能性**: 5%以下または95%以上の値

## まとめ

`validate_dataset.py`のパーセンタイル処理は、以下の目的で使用されます：

1. **データの分布の理解**: データの中央値、四分位数、極端な値を理解
2. **外れ値の検出**: 極端に小さい値または大きい値を検出
3. **データのスケールの理解**: データの範囲とスケールを理解
4. **データの品質の評価**: データの品質を評価（極端な値、クリッピングなど）

パーセンタイルは、データセットの統計的特性を理解するための重要な統計量です。特に、機械学習モデルの訓練前に、データの分布や外れ値を理解するために使用されます。

