# モデル評価結果の分析と改善案

## 評価プロット機能の解説

### 機能概要
`optuna_tutorial.py`の`save_trial_results`関数内で、`create_prediction_plots`関数を呼び出して評価プロットを生成しています。これらのプロットは以下の情報を提供します：

1. **予測値 vs 実測値の散布図**: 各ターゲット変数について、モデルの予測値と実測値の関係を可視化
2. **R²（決定係数）**: モデルがターゲット変数の分散をどれだけ説明できているかを示す指標（1に近いほど良好、負の値は平均値予測より悪い）
3. **RMSE（二乗平均平方根誤差）**: 予測誤差の平均的な大きさを示す指標（小さいほど良好）
4. **完璧な予測線（y=x）**: 赤い破線で表示され、理想的な予測を表す

### 評価指標の意味
- **R² > 0.8**: 非常に良好な予測性能
- **0.5 < R² < 0.8**: 中程度の予測性能
- **0 < R² < 0.5**: 低い予測性能
- **R² < 0**: モデルがターゲット変数の平均値を予測するよりも悪い性能

## 現在の結果分析

### 良好な性能（R² > 0.8）
1. **Gas Velocity**: R² = 0.964, RMSE = 4.197
   - 非常に良好な予測性能
   - データポイントがy=x線に密接に沿っている

2. **Gas Volume Fraction**: R² = 0.844, RMSE = 0.119
   - 良好な予測性能
   - 特に0.6以上の値で精度が高い

3. **Liquid Volume Fraction**: R² = 0.888, RMSE = 0.094
   - 非常に良好な予測性能
   - 誤差が非常に小さい

### 中程度の性能
4. **Liquid Velocity**: R² = 0.395, RMSE = 0.893
   - 改善の余地がある
   - 高めの実測値（5.5-6.0）で予測がばらついている

### 極めて悪い性能（R² < 0）
5. **Solid Velocity**: R² = -1.385, RMSE = 0.336
   - モデルが全く機能していない
   - 予測値は0.4-0.8に集中、実測値は0-0.8に広く分布

6. **Solid Volume Fraction**: R² = -65.237, RMSE = 0.237
   - 極めて悪い性能
   - 実測値は0.0-0.1に集中、予測値は0.1-0.5に大きくばらつく

## 改善案

### 1. 損失関数の重み付け
性能の悪いターゲット（Solid Velocity、Solid Volume Fraction）に高い重みを付けて学習することで、これらのターゲットの性能向上を図ります。

**実装方法**:
- ターゲットごとの重みを設定可能にする
- 重み付けMSE損失関数を使用
- Optunaのハイパーパラメータとして重みを最適化

### 2. ターゲット変数の正規化/スケーリング
ターゲット変数のスケールが異なる場合、正規化することで学習の安定性と性能を向上させます。

**実装方法**:
- StandardScalerまたはMinMaxScalerを使用
- 学習時は正規化したターゲットで学習
- 予測時は逆変換して元のスケールに戻す

### 3. マルチタスク学習の見直し
性能の悪いターゲットに対して、異なる学習戦略を適用します。

**実装方法**:
- 共有エンコーダと個別デコーダを持つマルチヘッドモデル
- 性能の悪いターゲットに対してより深いデコーダを使用
- ターゲットごとに異なる学習率を設定

### 4. データ品質の再確認
Solid VelocityとSolid Volume Fractionに関連するデータに問題がないか確認します。

**確認項目**:
- これらのターゲット変数の分布と統計
- 入力チャンネル（Channel 0, 2）とこれらのターゲットの相関
- 異常値や外れ値の存在

### 5. モデルアーキテクチャの改善
性能の悪いターゲットに対して、より適切なモデル構造を検討します。

**改善案**:
- より深いネットワーク構造
- アテンション機構の導入
- リカレント層の追加（時系列特性が強い場合）

### 6. ハイパーパラメータの調整
Optunaの探索空間を調整し、性能の悪いターゲットに重点を置いた最適化を行います。

**調整項目**:
- 学習率の範囲を拡大
- モデルの複雑度（hidden channels）の範囲を拡大
- ドロップアウト率の範囲を調整
- バッチサイズの範囲を調整

### 7. エラー分析の深化
性能の悪いターゲットについて、予測誤差が大きいサンプルを特定し、入力データを詳細に分析します。

**分析項目**:
- 誤差が大きいサンプルの入力チャンネル（Channel 0, 2）の特徴
- 誤差のパターン（過大評価/過小評価）
- 誤差が大きいサンプルのターゲット変数の値の範囲

## 実装優先順位

1. **最優先**: 損失関数の重み付け（実装が容易で効果が大きい）
2. **高優先度**: ターゲット変数の正規化（データの前処理として重要）
3. **中優先度**: データ品質の再確認（根本原因の特定）
4. **中優先度**: ハイパーパラメータの調整（Optunaの探索空間拡大）
5. **低優先度**: モデルアーキテクチャの改善（実装が複雑）

## 次のステップ

1. 損失関数の重み付け機能を実装
2. ターゲット変数の正規化オプションを追加
3. ターゲット別の詳細な評価指標を追加
4. エラー分析スクリプトを作成
5. 改善後のモデルで再学習・評価

